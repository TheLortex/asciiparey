!function(t){var e={};function i(s){if(e[s])return e[s].exports;var o=e[s]={i:s,l:!1,exports:{}};return t[s].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(s,o,function(e){return t[e]}.bind(null,o));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);class s{constructor(t,e){this.x=t,this.y=e}toIndex(){return this.pair().join(",")}pair(){return[this.x,this.y]}floor(){return new s(Math.floor(this.x),Math.floor(this.y))}clone(){return new s(this.x,this.y)}up(t){return new s(this.x,this.y-t)}down(t){return new s(this.x,this.y+t)}left(t){return new s(this.x-t,this.y)}right(t){return new s(this.x+t,this.y)}equals(t){return this.x==t.x&&this.y==t.y}}function o(t,e){let i=12*(e.x-t.x),o=(e.y-t.y)*(1.6*12);return new s(i,o)}function n(t,e){let i=e.x/12+t.x,o=e.y/(1.6*12)+t.y;return new s(i,o)}var l=function(t,e,i,s){return new(i||(i=Promise))((function(o,n){function l(t){try{r(s.next(t))}catch(t){n(t)}}function h(t){try{r(s.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(l,h)}r((s=s.apply(t,e||[])).next())}))};const h=/\w|\$|\#|\-|\./;class r{constructor(t){this.content=new Map,this.color=t,this.dirty=!0,this._commands=[]}setup(t){return l(this,void 0,void 0,(function*(){let e=window.localStorage.getItem("p-"+t);if(e)this.content=new Map(JSON.parse(e));else{this.content=new Map;let e=t;""==t&&(e="index");let i=yield fetch("./default/"+e+".ascii");if(i.ok){let t=yield i.text();this.write(new s(0,0),t)}}}))}clone(){let t=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return t.content=new Map(this.content),t}save(t){window.localStorage.setItem("p-"+t,JSON.stringify(Array.from(this.content.entries())))}renderGrid(t,e){let i=Math.ceil(t.canvas.height/(1.6*12)),s=Math.ceil(t.canvas.width/12);t.strokeStyle="#f0f0f0";for(let e=0;e<s;e++)t.beginPath(),t.moveTo(12*e,0),t.lineTo(12*e,t.canvas.height),t.stroke();for(let e=0;e<i;e++)t.beginPath(),t.moveTo(0,e*(1.6*12)),t.lineTo(t.canvas.width,e*(1.6*12)),t.stroke()}renderText(t,e){let i=Math.ceil(t.canvas.height/(1.6*12)),s=Math.ceil(t.canvas.width/12);t.strokeStyle="#000",t.font=1.6*12+"px Monospace";for(let o=0;o<i;o++)for(let i=0;i<s;i++){let s=[i+e.x,o+e.y],n=this.content.get(s.join(","));n&&(t.fillStyle=this.color,t.fillRect(12*i,o*(1.6*12),12,1.6*12),t.fillStyle="#111",t.fillText(n,12*i,(o+1)*(1.6*12)-5))}}render(t,e){this.renderGrid(t,e),this.renderText(t,e)}write(t,e){let i=t.clone(),s=i.x;for(let t of e)"\n"==t?(i.y+=1,i.x=s):(" "==t?this.content.delete(i.toIndex()):this.content.set(i.toIndex(),t),i.x+=1);this.dirty=!0}commands(t,e){return this.dirty&&(this.dirty=!1,this._commands=this.commandsMemo(t,e)),this._commands}commandsMemo(t,e){var i,o,n,l;let r=Math.ceil(t.canvas.height/(1.6*12)),a=Math.ceil(t.canvas.width/12),c=[];for(let t=0;t<r;t++){let r="",d=null;for(let n=0;n<a;n++){let l=[n+e.x,t+e.y],a=this.content.get(l.join(","));a&&d&&h.test(a)&&"$"!=a?r+=a:(r.length>0&&("select"!=r&&"box"!=r||c.push({kind:"$",to:r,position:new s(null!==(i=null==d?void 0:d[0])&&void 0!==i?i:-1,null!==(o=null==d?void 0:d[1])&&void 0!==o?o:-1)})),"$"==a&&(d=l,r=""))}r.length>0&&("select"!=r&&"box"!=r||c.push({kind:"$",to:r,position:new s(null!==(n=null==d?void 0:d[0])&&void 0!==n?n:-1,null!==(l=null==d?void 0:d[1])&&void 0!==l?l:-1)}))}return c}readLink(t){var e,i,s;let o=t.clone();if(!h.test(null!==(e=this.content.get(o.toIndex()))&&void 0!==e?e:""))return null;for(;h.test(null!==(i=this.content.get(o.toIndex()))&&void 0!==i?i:"");)o.x-=1;o.x+=1;let n=this.content.get(o.toIndex());if("#"!=n&&"$"!=n)return null;let l="",r=o.clone();for(o.x+=1;h.test(null!==(s=this.content.get(o.toIndex()))&&void 0!==s?s:" ");)l+=this.content.get(o.toIndex()),o.x+=1;return"$"!=n||"select"!=l&&"box"!=l&&"move_to"!=l&&"reset"!=l?"#"==n?{position:r,to:l,kind:n}:null:{position:r,to:l,kind:n}}copy(t,e){var i;t.x>e.x&&([e.x,t.x]=[t.x,e.x]),t.y>e.y&&([e.y,t.y]=[t.y,e.y]);let s=[];for(let o=t.y;o<=e.y;o++){let n="|";for(let s=t.x;s<=e.x;s++)n+=null!==(i=this.content.get([s,o].join(",")))&&void 0!==i?i:" ";s.push(n.trim().substring(1))}return s.join("\n")}erase(t,e){t.x>e.x&&([e.x,t.x]=[t.x,e.x]),t.y>e.y&&([e.y,t.y]=[t.y,e.y]);for(let i=t.y;i<=e.y;i++)for(let s=t.x;s<=e.x;s++)this.content.delete([s,i].join(","));this.dirty=!0}}class a{constructor(t){this.position=t,this.start_x=t.x,this.previous_state=null}clone(){let t=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return t.position=this.position.clone(),t}handleKey(t,e){if((t.keyCode>47&&t.keyCode<112&&93!=t.keyCode||t.keyCode>123&&t.keyCode<223||32==t.keyCode)&&!t.ctrlKey)e.write(this.position,t.key),this.previous_state=this.clone(),this.position.x+=1;else if(13==t.keyCode)this.previous_state=this.clone(),this.position.x=this.start_x,this.position.y+=1;else if(8==t.keyCode)this.previous_state?(e.write(this.previous_state.position," "),this.position=this.previous_state.position,this.previous_state=this.previous_state.previous_state):(this.position.x-=1,e.write(this.position," "));else{if(46!=t.keyCode)return!1;e.write(this.position," ")}return!0}write(t,e){for(let i of t)"\n"==i?(this.previous_state=this.clone(),this.position.x=this.start_x,this.position.y+=1):(e.write(this.position,i),this.previous_state=this.clone(),this.position.x+=1)}}class c{constructor(t){var e;this.history=[],this.history_index=0,this.mode="selection",this.edition_state=null;let i=null!==(e=decodeURI(document.URL).split("#")[1])&&void 0!==e?e:"";this.load(i),this.ctx=t,t.canvas.addEventListener("contextmenu",t=>this.onContextMenu(t)),t.canvas.addEventListener("keydown",t=>this.onKeyDown(t)),t.canvas.addEventListener("mousedown",t=>this.onMouseDown(t)),t.canvas.addEventListener("mousemove",t=>this.onMouseMove(t)),t.canvas.addEventListener("mouseup",t=>this.onMouseUp(t)),t.canvas.addEventListener("mouseout",t=>this.onMouseOut(t)),t.canvas.addEventListener("copy",t=>this.onCopy(t)),t.canvas.addEventListener("cut",t=>this.onCut(t)),t.canvas.addEventListener("paste",t=>this.onPaste(t)),window.addEventListener("popstate",t=>this.onPopState(t))}save(){this.state.save(this.page)}load(t){this.edition_state&&this.save(),this.page=t,this.offset=new s(0,0),this.update=!0,this.edition_state=null,this.hover_link=null,this.contextmenu_state=null,this.selection_state=null,this.state=new r("#fff"),this.state.setup(t).then(()=>this.scheduleRender()),this.history=[{state:this.state.clone(),edition_state:null,selection_state:null},{state:this.state,edition_state:null,selection_state:null}],this.history_index=1,0==t.length?document.title="n o t e s":document.title="n o t e s  #"+t}render(t){var e,i,s;(this.update||t)&&(this.update=!1,this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.contextmenu_state&&this.executeCommands(this.contextmenu_state),this.executeCommands(this.state),this.state.render(this.ctx,this.offset),this.renderLink(),this.renderEdition(),this.renderSelection(),null===(i=null===(e=this.selection_state)||void 0===e?void 0:e.preview)||void 0===i||i.render(this.ctx,this.offset),null===(s=this.contextmenu_state)||void 0===s||s.renderText(this.ctx,this.offset))}executeCommands(t){for(let e of t.commands(this.ctx,this.offset))if("box"==e.to){let i="";i="box"==this.mode?"✔️":"\t",t.write(e.position.right(e.to.length+3),i)}else if("select"==e.to){let i="";i="selection"==this.mode?"✔️":"\t",t.write(e.position.right(e.to.length+3),i)}}renderSelection(){if(this.selection_state){let t=this.selection_state.from.clone(),e=this.selection_state.to.clone();t.x>e.x&&([e.x,t.x]=[t.x,e.x]),t.y>e.y&&([e.y,t.y]=[t.y,e.y]),"selection"==this.mode&&(this.ctx.globalCompositeOperation="multiply",this.ctx.fillStyle="#b0c0f0",this.ctx.fillRect(12*t.x,t.y*(1.6*12),12*(e.x-t.x+1),(e.y-t.y+1)*(1.6*12)),this.ctx.globalCompositeOperation="source-over")}}renderEdition(){if(this.edition_state){let t=this.edition_state.position,e=o(this.offset,t);this.ctx.globalCompositeOperation="multiply",this.ctx.fillStyle="#b0c0f0",this.ctx.fillRect(e.x,e.y,12,1.6*12),this.ctx.globalCompositeOperation="source-over"}}renderLink(){if(this.hover_link){this.ctx.canvas.style.cursor="pointer";let t=this.hover_link.position,e=o(this.offset,t),i=this.hover_link.to.length;this.ctx.fillStyle="#fff",this.ctx.fillRect(e.x,e.y,12*(i+1),1.6*12),this.ctx.fillStyle="#08f",this.ctx.strokeStyle="#08f",this.ctx.fillText(this.hover_link.kind,e.x,e.y+1.6*12-5);for(let t=0;t<i;t++)this.ctx.fillText(this.hover_link.to[t],e.x+12*(1+t),e.y+1.6*12-5);this.ctx.moveTo(e.x,e.y+1.6*12),this.ctx.lineTo(e.x+12*(1+i),e.y+1.6*12),this.ctx.stroke()}else this.ctx.canvas.style.cursor="default"}stateStep(){var t,e;this.save(),this.history=this.history.slice(0,this.history_index+1),this.history.push({state:this.state,edition_state:this.edition_state,selection_state:this.selection_state}),this.history_index+=1,this.state=this.state.clone(),this.edition_state=null!==(e=null===(t=this.edition_state)||void 0===t?void 0:t.clone())&&void 0!==e?e:null,this.selection_state&&(this.selection_state=Object.assign({},this.selection_state))}onPopState(t){var e;let i=null!==(e=decodeURI(document.URL).split("#")[1])&&void 0!==e?e:"";this.load(i),this.scheduleRender()}onKeyDown(t){if(27==t.keyCode)return this.edition_state=null,this.contextmenu_state=null,this.selection_state=null,t.preventDefault(),void this.scheduleRender();if("z"!=t.key&&"Z"!=t.key||!t.ctrlKey)if(this.edition_state){let e=this.edition_state.handleKey(t,this.state);if(e&&this.stateStep(),t.keyCode>=37&&t.keyCode<=40){let i=1;t.ctrlKey&&(i=8),37==t.keyCode?this.edition_state.position.x-=i:38==t.keyCode?this.edition_state.position.y-=i:39==t.keyCode?this.edition_state.position.x+=i:40==t.keyCode&&(this.edition_state.position.y+=i),this.edition_state=new a(this.edition_state.position),e=!0}e&&(this.scheduleRender(),t.preventDefault())}else this.selection_state&&(8!=t.keyCode&&46!=t.keyCode||(this.state.erase(this.selection_state.from,this.selection_state.to),this.stateStep(),this.scheduleRender(),t.preventDefault()));else{if(t.shiftKey){if(this.history_index<this.history.length-1){this.history_index+=1;let t=this.history[this.history_index];this.state=t.state,this.edition_state=t.edition_state,this.selection_state=t.selection_state,this.save(),this.scheduleRender()}}else if(this.history_index>0){this.history_index-=1;let t=this.history[this.history_index];this.state=t.state,this.edition_state=t.edition_state,this.selection_state=t.selection_state,this.save(),this.scheduleRender()}t.preventDefault()}}onMouseDown(t){var e;let i=new s(t.x,t.y),o=n(this.offset,i).floor();0==t.button&&(this.edition_state=null,this.selection_state={selecting:!0,from:o,to:o,preview:"box"==this.mode?new r("#b0d0ff"):null},null===(e=this.selection_state.preview)||void 0===e||e.write(o,"+"))}onMouseMove(t){var e,i,o,l;let h=new s(t.x,t.y),a=n(this.offset,h).floor(),c=null!==(i=null===(e=this.contextmenu_state)||void 0===e?void 0:e.readLink(a))&&void 0!==i?i:null;c||(c=this.state.readLink(a));let d=!(null==c&&null==this.hover_link||(null==c?void 0:c.to)==(null===(o=this.hover_link)||void 0===o?void 0:o.to));if(null===(l=this.selection_state)||void 0===l?void 0:l.selecting){if(this.selection_state.to=a,"box"==this.mode){let t=this.selection_state.from.clone(),e=this.selection_state.to.clone();t.x>e.x&&([e.x,t.x]=[t.x,e.x]),t.y>e.y&&([e.y,t.y]=[t.y,e.y]),this.selection_state.preview=new r("#b0d0ff"),this.selection_state.preview.write(t,"║\n".repeat(e.y-t.y+1)),this.selection_state.preview.write(new s(e.x,t.y),"║\n".repeat(e.y-t.y+1)),t.x!=e.x&&(e.y==t.y?(this.selection_state.preview.write(t,"═".repeat(e.x-t.x+1)),this.selection_state.preview.write(new s(t.x,e.y),"═".repeat(e.x-t.x+1))):(this.selection_state.preview.write(t,"╔"+"═".repeat(e.x-t.x-1)+"╗"),this.selection_state.preview.write(new s(t.x,e.y),"╚"+"═".repeat(e.x-t.x-1)+"╝")))}d=!0}d&&(this.hover_link=c,this.scheduleRender())}onMouseOut(t){this.selection_state=null}onMouseUp(t){var e,i;this.scheduleRender();let o=new s(t.x,t.y),l=n(this.offset,o).floor();if(0==t.button){if(this.selection_state){if(this.selection_state.to=l,this.selection_state.selecting=!1,!this.selection_state.to.equals(this.selection_state.from)){if("box"==this.mode){for(const[t,s]of null!==(i=null===(e=this.selection_state.preview)||void 0===e?void 0:e.content.entries())&&void 0!==i?i:[])this.state.content.set(t,s);this.selection_state=null,this.stateStep()}return}this.selection_state=null}if(this.hover_link)"#"==this.hover_link.kind?(window.history.pushState({},"","#"+this.hover_link.to),this.load(this.hover_link.to)):("box"==this.hover_link.to?this.mode="box":"move_to"==this.hover_link.to?console.log("not implemented."):"select"==this.hover_link.to?this.mode="selection":"reset"==this.hover_link.to&&(window.localStorage.removeItem("p-"+this.page),this.load(this.page)),this.scheduleRender());else{let e=new s(t.x,t.y),i=n(this.offset,e).floor();this.edition_state=new a(i)}}}onContextMenu(t){t.preventDefault();let e=new s(t.x,t.y),i=n(this.offset,e).floor(),o="\n╔══════════════════════════════╗\n║$select:   Selection mode.    ║\n║$box:      Box drawing mode.  ║\n";this.selection_state&&(o+="╟──────────────────────────────╢\n║$move_to:  Teleport selection ║\n"),o+="╚══════════════════════════════╝\n",this.contextmenu_state=new r("#adf"),this.contextmenu_state.write(i.right(1),o.replace(/\ /gi,"\t")),this.scheduleRender()}onCopy(t){var e,i;0==(null===(e=this.selection_state)||void 0===e?void 0:e.selecting)&&(null===(i=t.clipboardData)||void 0===i||i.setData("text/plain",this.state.copy(this.selection_state.from,this.selection_state.to)),t.preventDefault())}onCut(t){var e,i;0==(null===(e=this.selection_state)||void 0===e?void 0:e.selecting)&&(null===(i=t.clipboardData)||void 0===i||i.setData("text/plain",this.state.copy(this.selection_state.from,this.selection_state.to)),this.state.erase(this.selection_state.from,this.selection_state.to),this.stateStep(),t.preventDefault(),this.scheduleRender())}onPaste(t){t.clipboardData&&this.edition_state&&(this.edition_state.write(t.clipboardData.getData("text"),this.state),this.stateStep(),this.scheduleRender())}scheduleRender(){window.requestAnimationFrame(()=>this.render(!0))}}console.log("yo");let d=document.getElementById("cvs"),u=d.getContext("2d");if(d.width=document.documentElement.clientWidth,d.height=document.documentElement.clientHeight,u){let t,e=new c(u);window.requestAnimationFrame(()=>e.render(!0)),window.addEventListener("resize",()=>{console.log("hey"),t&&window.cancelAnimationFrame(t),t=window.requestAnimationFrame(()=>{d.width=document.documentElement.clientWidth,d.height=document.documentElement.clientHeight,e.render(!0)})})}else console.log("Failed to get canvas.")}]);